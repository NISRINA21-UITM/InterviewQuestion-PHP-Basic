CREATE DATABASE company_db;

-- Create employee_profile_table
CREATE TABLE employee_profile_table (
    employee_id INT PRIMARY KEY,
    employee_no INT,
    employee_name VARCHAR(100),
    ic_no VARCHAR(20)
);

-- Create job_profile_table
CREATE TABLE job_profile_table (
    job_id INT PRIMARY KEY,
    job_name VARCHAR(100)
);

-- Create employee_job_table
CREATE TABLE employee_job_table (
    employee_id INT,
    job_id INT,
    effective_date DATE,
    PRIMARY KEY (employee_id, job_id, effective_date),
    FOREIGN KEY (employee_id) REFERENCES employee_profile_table(employee_id),
    FOREIGN KEY (job_id) REFERENCES job_profile_table(job_id)
);

-- Insert sample data into employee_profile_table
INSERT INTO employee_profile_table (employee_id, employee_no, employee_name, ic_no) VALUES
(1, 1000, 'Ali', '1234'),
(2, 1001, 'Ahmad', '2345'),
(3, 1002, 'Koay', '3456'),
(4, 1003, 'Lau', '4567');

-- Insert sample data into job_profile_table
INSERT INTO job_profile_table (job_id, job_name) VALUES
(1, 'Finance'),
(2, 'Developer'),
(3, 'Admin'),
(4, 'Senior Developer');

-- Insert sample data into employee_job_table
INSERT INTO employee_job_table (employee_id, job_id, effective_date) VALUES
(1, 2, '2019-01-01'),
(1, 4, '2020-01-01'),
(2, 2, '2018-01-01'),
(3, 3, '2017-05-14'),
(4, 1, '2019-06-09');

-- a. Update the employee with employee_no 1002 job to 4, with effective 2020-01-01.
UPDATE employee_job_table
SET job_id = 4, effective_date = '2020-01-01'
WHERE employee_id = (SELECT employee_id FROM employee_profile_table WHERE employee_no = 1002);

-- b. List out the employee name, employee no, effective date, job title.
SELECT ep.employee_name, ep.employee_no, ej.effective_date, jp.job_name
FROM employee_profile_table ep
JOIN employee_job_table ej ON ep.employee_id = ej.employee_id
JOIN job_profile_table jp ON ej.job_id = jp.job_id;

-- c. List out the employee name, employee no, latest job title.
SELECT ep.employee_name, ep.employee_no, jp.job_name
FROM employee_profile_table ep
JOIN employee_job_table ej ON ep.employee_id = ej.employee_id
JOIN job_profile_table jp ON ej.job_id = jp.job_id
WHERE ej.effective_date = (
    SELECT MAX(effective_date)
    FROM employee_job_table
    WHERE employee_id = ep.employee_id
);

-- d. Delete all employee with employee_no 1000 job title, with effective date of 2020-01-01.
DELETE FROM employee_job_table
WHERE employee_id = (SELECT employee_id FROM employee_profile_table WHERE employee_no = 1000)
AND effective_date = '2020-01-01';